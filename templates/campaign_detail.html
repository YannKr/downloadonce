{{define "content"}}
<div class="page-header">
  <h1>{{.Data.Campaign.Name}}</h1>
  <div>
    {{stateBadge .Data.Campaign.State}}
    {{if eq .Data.Campaign.State "DRAFT"}}
    <form method="POST" action="/campaigns/{{.Data.Campaign.ID}}/publish" style="display:inline"
          onsubmit="return confirm('Publish this campaign? Download links will be emailed to all recipients.')">
      {{.CSRFField}}
      <button type="submit" class="btn btn-primary">Publish</button>
    </form>
    <form method="POST" action="/campaigns/{{.Data.Campaign.ID}}/clone" style="display:inline"
          onsubmit="return confirm(\"Clone this campaign?\n\nThis will create a new draft with the same recipients and settings.\")">
      {{.CSRFField}}
      <button type="submit" class="btn btn-secondary">Clone Campaign</button>
    </form>
    {{end}}
  </div>
</div>

<div class="detail-grid">
  <div class="detail-item">
    <span class="detail-label">Asset</span>
    <span class="detail-value-truncate">{{.Data.Asset.OriginalName}} ({{.Data.Asset.AssetType}})</span>
  </div>
  <div class="detail-item">
    <span class="detail-label">Recipients</span>
    <span>{{.Data.Campaign.RecipientCount}}</span>
  </div>
  <div class="detail-item">
    <span class="detail-label">Downloads</span>
    <span>{{.Data.Campaign.DownloadedCount}}</span>
  </div>
  <div class="detail-item">
    <span class="detail-label">Created</span>
    <span>{{formatTime .Data.Campaign.CreatedAt}}</span>
  </div>
  {{if .Data.Campaign.ExpiresAt}}
  <div class="detail-item">
    <span class="detail-label">Expires</span>
    <span>{{formatTimePtr .Data.Campaign.ExpiresAt}}</span>
  </div>
  {{end}}
  {{if .Data.Campaign.MaxDownloads}}
  <div class="detail-item">
    <span class="detail-label">Max Downloads</span>
    <span>{{derefInt .Data.Campaign.MaxDownloads}} per recipient</span>
  </div>
  {{end}}
</div>

{{if or (eq .Data.Campaign.State "READY") (eq .Data.Campaign.State "PROCESSING") (eq .Data.Campaign.State "EXPIRED")}}
<div class="export-bar" style="margin-bottom:1rem;">
  <span style="margin-right:0.5rem;">Export links:</span>
  <button class="btn btn-sm btn-secondary" onclick="copyLinksToClipboard()">Copy to clipboard</button>
  <a href="/campaigns/{{.Data.Campaign.ID}}/export-links?format=csv" class="btn btn-sm btn-secondary">Download CSV</a>
  <a href="/campaigns/{{.Data.Campaign.ID}}/export-links?format=txt" class="btn btn-sm btn-secondary">Download TXT</a>
</div>
<script>
async function copyLinksToClipboard() {
  try {
    const resp = await fetch("/campaigns/{{.Data.Campaign.ID}}/export-links?format=txt");
    if (!resp.ok) throw new Error("Export failed");
    const text = await resp.text();
    await navigator.clipboard.writeText(text);
    const btn = document.querySelector("[onclick=\"copyLinksToClipboard()\"]");
    const origText = btn.textContent;
    btn.textContent = "Copied!";
    setTimeout(() => { btn.textContent = origText; }, 2000);
  } catch (err) {
    alert("Copy failed: " + err.message);
  }
}
</script>
{{end}}
<h2>Download Tokens</h2>
<table>
  <thead>
    <tr>
      <th>Recipient</th>
      <th>Email</th>
      <th>State</th>
      <th>Progress</th>
      <th>Downloads</th>
      <th>Link</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {{range .Data.Tokens}}
    {{$tokenID := .ID}}
    <tr id="token-{{.ID}}">
      <td>{{.RecipientName}}</td>
      <td>{{.RecipientEmail}}</td>
      <td id="state-{{.ID}}">{{stateBadge .State}}</td>
      <td id="progress-cell-{{.ID}}">
        {{with index $.Data.Jobs $tokenID}}
        <div class="progress-bar" id="progress-{{$tokenID}}">
          <div class="progress-fill" style="width: {{.Progress}}%"></div>
          <span class="progress-text">{{.Progress}}%</span>
        </div>
        {{else}}
          {{if eq .State "ACTIVE"}}
          <span class="text-muted">Done</span>
          {{else if eq .State "PENDING"}}
          <span class="text-muted">--</span>
          {{else}}
          <span class="text-muted">--</span>
          {{end}}
        {{end}}
      </td>
      <td>{{.DownloadCount}}</td>
      <td id="link-{{.ID}}">
        {{if eq .State "ACTIVE"}}
        <div class="url-group">
          <input type="text" value="{{$.Data.BaseURL}}/d/{{.ID}}" readonly class="url-input" onclick="this.select()">
          <button class="btn btn-sm btn-copy" onclick="copyLink(this)" data-url="{{$.Data.BaseURL}}/d/{{.ID}}">Copy</button>
        </div>
        {{else if eq .State "PENDING"}}
          {{if eq $.Data.Campaign.State "DRAFT"}}
        <span class="text-muted">Awaiting publish</span>
          {{else}}
        <span class="text-muted">Preparing...</span>
          {{end}}
        {{else}}
        <span class="text-muted">--</span>
        {{end}}
      </td>
      <td>
        {{if eq .State "ACTIVE"}}
        <form method="POST" action="/campaigns/{{$.Data.Campaign.ID}}/tokens/{{.ID}}/revoke"
              onsubmit="return confirm('Revoke this token?')">
          {{$.CSRFField}}
          <button type="submit" class="btn btn-sm btn-danger">Revoke</button>
        </form>
        {{end}}
      </td>
    </tr>
    {{if .DownloadEvents}}
    <tr>
      <td colspan="7">
        <details>
          <summary>Download history ({{len .DownloadEvents}})</summary>
          <table class="subtable">
            <thead><tr><th>Time</th><th>IP Address</th><th>User Agent</th></tr></thead>
            <tbody>
              {{range .DownloadEvents}}
              <tr>
                <td>{{formatTime .CreatedAt}}</td>
                <td>{{.IPAddress}}</td>
                <td class="text-truncate">{{.UserAgent}}</td>
              </tr>
              {{end}}
            </tbody>
          </table>
        </details>
      </td>
    </tr>
    {{end}}
    {{end}}
  </tbody>
</table>

<a href="/campaigns" class="btn btn-secondary">Back to Campaigns</a>

<script>
  connectCampaignSSE("{{.Data.Campaign.ID}}");
</script>
{{end}}
